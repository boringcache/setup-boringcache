name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  test-setup:
    name: Test Setup (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            expected-asset: boringcache-ubuntu-24.04-amd64
          - os: ubuntu-24.04
            expected-asset: boringcache-ubuntu-24.04-amd64
          - os: macos-latest
            expected-asset: boringcache-macos-15-arm64
          - os: windows-latest
            expected-asset: boringcache-windows-2022-amd64.exe

    steps:
      - uses: actions/checkout@v4

      - name: Setup BoringCache CLI
        id: setup
        uses: ./
        with:
          version: v1.0.1

      - name: Verify installation
        run: boringcache --version

      - name: Check outputs
        shell: bash
        run: |
          echo "Version: ${{ steps.setup.outputs.version }}"
          echo "Path: ${{ steps.setup.outputs.path }}"
          echo "Cache hit: ${{ steps.setup.outputs.cache-hit }}"
          echo "Asset: ${{ steps.setup.outputs.asset }}"

      - name: Verify asset detection
        shell: bash
        run: |
          if [ "${{ steps.setup.outputs.asset }}" != "${{ matrix.expected-asset }}" ]; then
            echo "Asset mismatch: expected '${{ matrix.expected-asset }}', got '${{ steps.setup.outputs.asset }}'"
            exit 1
          fi
          echo "Asset correctly detected: ${{ steps.setup.outputs.asset }}"

      - name: Verify binary is executable
        shell: bash
        run: |
          which boringcache
          boringcache --help

  test-cache-hit:
    name: Test Cache Hit (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: First setup (may be cache miss)
        id: first
        uses: ./
        with:
          version: v1.0.1

      - name: Second setup (should be cache hit)
        id: second
        uses: ./
        with:
          version: v1.0.1

      - name: Verify cache was used
        shell: bash
        run: |
          echo "First run cache-hit: ${{ steps.first.outputs.cache-hit }}"
          echo "Second run cache-hit: ${{ steps.second.outputs.cache-hit }}"
          if [ "${{ steps.second.outputs.cache-hit }}" != "true" ]; then
            echo "Expected cache hit on second run"
            exit 1
          fi

  test-skip-cache:
    name: Test Skip Cache
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup with skip-cache
        id: setup
        uses: ./
        with:
          version: v1.0.1
          skip-cache: true

      - name: Verify installation
        run: boringcache --version

      - name: Check cache-hit is false
        run: |
          echo "Cache hit: ${{ steps.setup.outputs.cache-hit }}"
          if [ "${{ steps.setup.outputs.cache-hit }}" != "false" ]; then
            echo "Expected cache-hit to be false when skip-cache is true"
            exit 1
          fi

  test-checksum-verification:
    name: Test Checksum Verification
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup with checksum verification (default)
        uses: ./
        with:
          version: v1.0.1
          skip-cache: true

      - name: Verify installation
        run: boringcache --version

  test-checksum-disabled:
    name: Test Checksum Disabled
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup with checksum verification disabled
        uses: ./
        with:
          version: v1.0.1
          verify-checksum: false
          skip-cache: true

      - name: Verify installation
        run: boringcache --version

  test-platform-override:
    name: Test Platform Override
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Setup BoringCache CLI with platform override
        id: setup
        uses: ./
        with:
          version: v1.0.1
          platform: ubuntu-22.04-amd64

      - name: Verify asset override
        run: |
          if [ "${{ steps.setup.outputs.asset }}" != "boringcache-ubuntu-22.04-amd64" ]; then
            echo "Asset mismatch: expected 'boringcache-ubuntu-22.04-amd64', got '${{ steps.setup.outputs.asset }}'"
            exit 1
          fi
          echo "Platform override correctly applied: ${{ steps.setup.outputs.asset }}"

      - name: Verify binary works
        run: boringcache --version

  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:ci

      - name: Build
        run: npm run build

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Uncommitted changes detected after build:"
            git status --porcelain
            git diff
            exit 1
          fi
